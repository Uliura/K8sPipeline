steps:

  - script: |
        chown -R $USER:$USER /var/run/docker.sock
    displayName: try to run docker

  - task: Docker@2
    displayName: Build and push an image to container registry
    inputs:
      containerRegistry: '$(dockerRegistryServiceConnection)'
      repository: '$(imageRepository)'
      command: 'build'
      Dockerfile: '$(dockerfilePath)'
      tags: '$(tag)'
      arguments: '-v /var/run/docker.sock:/var/run/docker.sock \'
      addPipelineData: false
      addBaseImageData: false

  - task: PublishPipelineArtifact@1
    inputs:
      artifactName: 'manifests'
      path: 'manifests'